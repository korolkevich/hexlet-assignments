# Validation

Валидация — это проверка полученных данных на соответствие заданным условиям и ограничениям. В этом задании мы познакомимся с валидацией данных в Javalin на примере создания нового пользователя. Так как валидация при редактировании пользователя точно такая же как и при создании, другие маршруты реализовывать не будем, чтобы не перегружать упражнение кодом.

## Ссылки

* [Класс Validator для валидация данных из форм в Javalin](https://javalin.io/documentation#validation)
* [Метод isValid() класса EmailValidator для проверки email на валидность](https://commons.apache.org/proper/commons-validator/apidocs/org/apache/commons/validator/routines/EmailValidator.html#isValid-java.lang.String-)
* [Метод isNumeric() проверяет, что строка содержит только цифры](https://commons.apache.org/proper/commons-lang/apidocs/org/apache/commons/lang3/StringUtils.html#isNumeric-java.lang.CharSequence-)

## src/main/java/controllers/UserController.java

В классе уже реализованы обработчики для вывода списка всех пользователей, просмотра данных конкретного пользователя и вывода страницы создания нового пользователя.

## Задачи

* Допишите обработчик `createUser`, который создаёт нового пользователя. В этом обработчике нужно будет выполнить валидацию введенных данных по следующим правилам:

  * Имя пользователя (`firstName`) — строка, не должно быть пустым
  * Фамилия (`lastName`) — строка, не должно быть пустым
  * Email (`email`) — строка, должен быть валидным Email.
  * Пароль (`password`) — должен быть не короче 4 символов и содержать только цифры.

  Если данные не прошли валидацию, установите код ответа 422 (Unprocessable Entity) и отобразите страницу создания нового пользователя (шаблон *users/new*). Под каждым полем, которое заполнено не правильно, должны отображаться сообщения об ошибках. Для удобства сами поля формы должны быть заполнены введенными данными. Для этого понадобится передать в шаблон словарь с ошибками и данные пользователя. Установите два атрибута:

  * Атрибут "errors" со значением `Map<String, List<ValidationError<? extends Object>>>`. Ключом в словаре будет название поля, не прошедшего валидацию, а значением — список ошибок валидации `ValidationError` этого поля.
  * Атрибут "user" со значением `User`, которое будет содержать введенные данные пользователя.

  Если все данные введены корректно, добавьте нового пользователя в базу данных, установите в сессию flash-сообщение об успешном создании пользователя (атрибут "flash") и сделайте редирект на страницу просмотра всех пользователей.

  Важное замечание! В реальной разработке пароль пользователя не хранят в базе данных в открытом виде в целях безопасности. Перед сохранением данных пароль хешируют и хранят в зашифрованном виде. В этом упражнении в целях упрощения мы этого не делаем.

## src/main/resources/templates/users/new.html

## Задачи

* Изучите шаблон *new.html*. Обратите внимание, как организован вывод ошибок для каждого из полей формы.

## Подсказки

* Чтобы провалидировать данные одного поля из формы, воспользуйтесь методом `formParamAsClass()`. Вызов этого метода вернет валидатор — объект класса `Validator`.

* Чтобы добавить в валидатор проверку, используйте метод `check()`. Этот метод первым аргументом принимает предикат, при помощи которого выполняется проверка данных. Если предикат возвращает `true`, данные из поля считаются валидными, если `false`, то не валидными.
Вторым параметром метод принимает сообщение об ошибке на случай, если данные не прошли проверку. В дальнейшем это сообщение будет выводиться под полями в форме создания пользователя.

```java
Validator<String> nameValidator = ctx.formParamAsClass("name", String.class)
    .check(it -> it.length() > 2), "Имя должно содержать больше двух символов");
```

* Для проверки Email на валидность удобно воспользоваться методом `isValid()` класса `EmailValidator`. Этот метод возвращает `true`, если Email валидный.

* Для проверки пароля можно воспользоваться методом `isNumeric()` класса `StringUtils`. Метод возвращает `true`, если строка содержит только цифры и `false` в ином случае.

* В валидатор можно добавить несколько проверок, для этого нужно просто несколько раз вызвать метод `check()`

* В Javalin есть метод `JavalinValidation.collectErrors()`, который позволяет автоматически получить ошибки из нескольких валидаторов и собрать их в словарь. В качестве аргументов он принимает объекты класса `Validator`. Результатом работы будет словарь, в котором ключ — это значение поля, не прошедшего валидацию, а значение — список ошибок.

```java
// Если ошибок нет, словарь будет пустой
Map<String, List<ValidationError<? extends Object>>> errors = JavalinValidation.collectErrors(
    nameNameValidator,
    ageValidator, ...
);
```
